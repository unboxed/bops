name: deploy-environment
on:
  workflow_call:
    inputs:
      environment-name:
        type: string
        required: true
      environment-cmd-name:
        type: string
        required: true
      ubuntu-version:
        type: string
        default: "latest"

concurrency:
  group: ${{ inputs.environment-name }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment-name }}
    runs-on: ubuntu-${{ inputs.ubuntu-version }}
    environment: ${{ inputs.environment-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.5

      - name: Install gems
        run: |
          gem install bundler
          bundle install --jobs 4 --retry 3 --path vendor/bundle

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-2

      - run: echo "Deploying to ${{ inputs.environment-name }} on branch $GITHUB_REF"

      - name: Deploy ${{ inputs.environment-name }} application
        run: |
          bundle exec rake deploy:${{ inputs.environment-cmd-name }}
