# BOPS ![CI](https://github.com/unboxed/bops/workflows/CI/badge.svg)

Back Office Planning System (BOPS)

| Dependency | Version |
| ---------- | ------- |
| Ruby       | 2.6.5   |
| Rails      | 6.0.2.2 |
| Postgresql | 1.2.3   |
| Node       | 13.8.0  |
| Yarn       | 1.15.2  |

## Preflight

### Clone the project

```sh
$ git clone git@github.com:unboxed/bops.git
```

## Building the project for local development

### Using Docker

First build and launch the images:

```sh
docker-compose up
```

Once your containers are running, you can use the Makefile to get a
prompt and run a couple extra commands:

```sh
make prompt

root@232515c34d14:/app# bin/rails db:reset
root@232515c34d14:/app# yarn
```

### Locally

#### Install the project's dependencies using bundler and yarn:

```sh
$ bundle install
$ yarn install
```

#### Enable the PostGIS extension:

Within psql's CLI, enable the postgis and postgis_topology extensions:

```sh
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;
```

#### Create the databases

```sh
$ rails db:setup
```

#### Tests

You can run the full test suite using following command:

```sh
$ rspec
```

Individual system specs with opening Chrome browser can be run using the following command:

```sh
$ JS_DRIVER=selenium_chrome rspec spec/system/log_in_spec.rb
```

#### Start the server:

```sh
$ rails server
```

#### Because of the subdomain being enforced, your options to test subdomains include using bops-care.link (needed to test [BOPS-applicants](https://github.com/unboxed/bops-applicants)) or, if you're just testing BOPS, Chrome, Firefox and Brave currently support subdomains too. This means your app will be available on:

```
http://southwark.bops-care.link:3000/

http://lambeth.bops-care.link:3000/

http://buckinghamshire.bops-care.link:3000/

or

http://southwark.southwark.localhost:3000/

http://lambeth.lambeth.localhost:3000/

http://buckinghamshire.buckinghamshire.localhost:3000/

```
## Dependencies

You will need to install `wkhtmltopdf` locally as this renders the PDF of the decision notice. Install this with the command:

```
brew install --cask wkhtmltopdf
```

## API

API documentation is available at /api-docs/index.html and can be autogenerated by running:

```
rake rswag:specs:swaggerize
```

## Creating data through the API

Once you have the application running, you can submit planning application through the API. You can do this through the provided swagger documentation at /api-docs/index.html

* Click Authorize and fill in the API key ('123' if not otherwise specified at db:seed)
* POST /api​/v1​/planning_applications > Try it out > Choose 'Full' example > Click Execute.

[1]: https://www.docker.com/products/docker-desktop
[2]: http://localhost:3000/

## Working with the bops-applicants front end

When testing bops-applicants emails on localhost, you will need to export the APPLICANTS_APP_HOST variable, with defines the link being sent in emails from BOPS. Running bops-applicants on port 3001 for southwark for ex:

```
export APPLICANTS_APP_HOST=bops-care.link:3001
```


## Working with api documentation: aggregate swagger files

We need a single openapi file to exist, but to keep the code easier to maintain we have multiple files that are then compiled into this single file:

```
public/api-docs/v1/_build/swagger_doc.yaml
```

So to create a new api endpoint, create your yaml doc inside public/api-docs/v1 and reference it in

```
public/api-docs/v1/swagger_doc.yaml
```

like so:

```
  $ref: "./your_new_file_name.yaml"
```

Make changes to your new file, and when you're happy aggregate them into our single file by installing this package in your machine:

```
npm install -g swagger-cli
```

and running:

```
swagger-cli bundle public/api-docs/v1/swagger_doc.yaml --outfile public/api-docs/v1/_build/swagger_doc.yaml --type yaml
```
