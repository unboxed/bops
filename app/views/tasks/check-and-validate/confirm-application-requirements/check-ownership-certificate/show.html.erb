<%= render "shared/task_header", task: @task %>

<%= render "shared/location_map", locals: {geojson: @planning_application.boundary_geojson} %>

<div class="govuk-!-margin-top-3">
  <%= render "planning_applications/validation/ownership_certificates/relevant_documents_accordion" %>
</div>

<table class="govuk-table">
  <tbody class="govuk-table__body">
    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">Certificate type</th>
      <td class="govuk-table__cell">
        <%= @planning_application.ownership_certificate.present? ? @planning_application.ownership_certificate.certificate_type.upcase : "Not specified" %>
      </td>
    </tr>
    <% if @planning_application.ownership_certificate.present? && @planning_application.ownership_certificate.land_owners.any? %>
      <% @planning_application.ownership_certificate.land_owners.each_with_index do |owner, i| %>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header govuk-!-font-weight-regular">Owner <%= i + 1 %></th>
          <td class="govuk-table__cell">&nbsp</td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Name</th>
          <td class="govuk-table__cell"><%= owner.name %></td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Address</th>
          <td class="govuk-table__cell"><%= owner.address %></td>
        </tr>
        <tr class="govuk-table__row">
          <th scope="row" class="govuk-table__header">Notice given</th>
          <td class="govuk-table__cell"><%= owner.notice_given? ? "Yes" : "No" %></td>
        </tr>
        <% if owner.notice_given? %>
          <tr class="govuk-table__row">
            <th scope="row" class="govuk-table__header">Notice date</th>
            <td class="govuk-table__cell"><%= owner.notice_given_at&.to_fs(:day_month_year_slashes) %></td>
          </tr>
        <% else %>
          <tr class="govuk-table__row">
            <th scope="row" class="govuk-table__header">Reason no notice given</th>
            <td class="govuk-table__cell"><%= owner.notice_reason %></td>
          </tr>
        <% end %>
      <% end %>
    <% end %>
  </tbody>
</table>
<div data-controller="unsaved-changes"
          data-action="beforeunload@window->unsaved-changes#handleBeforeUnload">
  <%= form_with model: @form, url: @form.url,
        data: {unsaved_changes_target: "form", action: "submit->unsaved-changes#handleSubmit"} do |form| %>

    <%= form.govuk_error_summary %>
    <%= form.govuk_radio_buttons_fieldset :valid_ownership_certificate, legend: {text: "Is this declaration correct?"} do %>
      <%= form.govuk_radio_button :valid_ownership_certificate, true, label: {text: "Yes"}, disabled: @form.read_only?, checked: @planning_application.valid_ownership_certificate == true %>
      <%= form.govuk_radio_button :valid_ownership_certificate, false, label: {text: "No"}, disabled: @form.read_only?, checked: @planning_application.valid_ownership_certificate == false do %>
        <%= form.govuk_text_area :invalidated_ownership_reason,
              value: @form.invalidated_ownership_reason,
              disabled: @form.read_only?,
              label: {size: "s", text: "Tell the applicant why their ownership certificate type is wrong"},
              hint: {text: "This request will be added to the application. The requests will not be sent until the application is marked as invalid."},
              rows: 5 %>
        <% end %>
    <% end %>
    <% if @planning_application.ownership_certificate_validation_requests.open_or_pending.any? %>
      <% if @planning_application.ownership_certificate_validation_requests.open.any? %>
        <p>Request for more information about ownership certificate has been sent to applicant</p>
      <% else %>
        <p>Request for more information about ownership certificate will be sent once application has been made invalid</p>
      <% end %>
    <% end %>
  <%= render "shared/task_submit_buttons", form: form, save_draft: false %>
<% end %>
</div>
