<% content_for :page_title do %>
  Add pre-commencement conditions - <%= t("page_title") %>
<% end %>

<%= render(
      partial: "shared/assessment_task_breadcrumbs",
      locals: { planning_application: @planning_application }
    ) %>

<% content_for :title, "Add pre-commencement conditions" %>

<%= render(
      partial: "shared/proposal_header",
      locals: { heading: "Add pre-commencement conditions" }
    ) %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= render(
          AccordionComponent.new(
            planning_application: @planning_application,
            sections: %w[constraints considerations]
          )
        ) %>

    <% if review = @condition_set.current_review %>
      <%= render "planning_applications/assessment/conditions/comment", review: review %>
    <% end %>

    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

    <div class="govuk-grid-column-full">
      <ul id="conditions-list" class="govuk-list">
        <% @conditions.each_with_index do |condition, i| %>
          <%= next unless condition.persisted? %>
          <%= content_tag(:li, id: dom_id(condition), class: "govuk-!-margin-bottom-7") do %>
            <span class="govuk-caption-m">Condition <%= i + 1 %></span>
            <h2 class="govuk-heading-m"><%= condition.title %></h2>

            <p style="float: none">
              <%= render(StatusTags::BaseComponent.new(status: status(condition), task_list: false)) %>
            </p>

            <% if current_request = condition.current_validation_request %>
              <% if current_request.rejection_reason %>
                <%= govuk_inset_text(classes: ["applicant"]) do %>
                  <p class="govuk-body">
                    <strong>Applicant comment</strong>
                  </p>
                  <p class="govuk-body govuk-hint">
                    Sent on: <%= current_request.updated_at.to_fs %>
                  </p>
                  <p class="govuk-body">
                    <%= current_request.rejection_reason %>
                  </p>
                <% end %>
              <% end %>
            <% end %>

            <p class="govuk-body govuk-hint">
              <% if current_request.notified_at %>
                Sent on <%= current_request.notified_at.to_fs %>
              <% end %>
            </p>
            <p class="govuk-body">
              <strong>Condition</strong><%= render(FormattedContentComponent.new(text: condition.text)) %>
            </p>
            <p class="govuk-body">
              <strong>Reason</strong><%= render(FormattedContentComponent.new(text: condition.reason)) %>
            </p>

            <% unless current_request.cancelled? || current_request.open? %>
              <%= govuk_link_to "Update condition", edit_planning_application_assessment_pre_commencement_condition_path(@planning_application, condition) %>
            <% end %>

            <% if current_request.pending? %>
              <%= govuk_link_to(
                "Remove", 
                planning_application_assessment_pre_commencement_condition_path(@planning_application, condition),
                method: :delete, 
                data: {confirm: "Are you sure?"}
              ) %>
            <% end %>

            <% if current_request.open? %>
              <%= govuk_link_to "Cancel", cancel_confirmation_planning_application_validation_validation_request_path(@planning_application, current_request) %>
            <% end %>
          <% end %>

          <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
        <% end %>
      </ul>

      <details class="govuk-details" <%= 'open' if @condition.errors.any? %>>
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">
            Add new pre-commencement condition
          </span>
        </summary>
        <div class="govuk-details__text">
          <%= render "form", url: planning_application_assessment_pre_commencement_conditions_path(@planning_application) %>
        </div>
      </details>

      <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

      <%= form_with model: @condition, url: confirm_planning_application_assessment_pre_commencement_conditions_path(@planning_application) do |form| %>
        <%= form.govuk_submit(t("form_actions.pre_commencement_condition.confirm")) do %>
          <%= govuk_button_link_to("Back", planning_application_assessment_tasks_path(@planning_application), secondary: true) %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
