<% content_for :page_title do %>
  Send letters to neighbours - <%= t('page_title') %>
<% end %>

<% add_parent_breadcrumb_link "Home", root_path %>
<% add_parent_breadcrumb_link "Application", planning_application_path(@planning_application) %>
<% add_parent_breadcrumb_link "Consultation", planning_application_consultation_path(@planning_application) %>
<% content_for :title, "Send letters to neighbours" %>

<%= render(
  partial: "shared/proposal_header",
  locals: { heading: "Send letters to neighbours" }
) %>

<% if flash[:sent_neighbour_letters].present? %>
  <div class="govuk-notification-banner govuk-notification-banner--success" role="alert"
    aria-labelledby="govuk-notification-banner-title"
    data-module="govuk-notification-banner">
    <div class="govuk-notification-banner__header">
      <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
        Success
      </h2>
    </div>
    <div class="govuk-notification-banner__content">
      <h3 class="govuk-notification-banner__heading">
        Letters have been sent to neighbours and a copy of the letter has been sent to the applicant.
      </h3>
      <p class="govuk-body">Contact <a class="govuk-notification-banner__link" href="https://www.notifications.service.gov.uk/support">GOV.UK Notify</a> if you think thereâ€™s a problem.</p>
    </div>
  </div>
<% end %>

<% if @consultation.neighbour_review&.to_be_reviewed? %>
  <%= govuk_inset_text do %>
    <h3 class="govuk-heading-s">
      Reviewer requested changes
    </h3>

    <p class="govuk-body">
      <%= @consultation.neighbour_review.comment %>
    </p>
  <% end %>
<% end %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <%= form_with(
      builder: GOVUKDesignSystemFormBuilder::FormBuilder,
      model: @consultation,
      method: :post,
      url: send_letters_planning_application_consultation_neighbour_letters_path(@planning_application)
    ) do |form| %>
      <% if @consultation.errors.any? %>
        <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
          <h2 class="govuk-error-summary__title" id="error-summary-title">
            There is a problem
          </h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
              <% @consultation.errors.each do |error| %>
                <li><%= error.message.html_safe %></li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>

      <%= render "list", planning_application: @planning_application, consultation: @consultation, form: form %>

      <%= render "letter_template", planning_application: @planning_application, consultation: @consultation, form: form %>

      <div class="govuk-button-group govuk-!-margin-top-5 align-buttons">
        <%= form.submit "Confirm and send letters", class: "govuk-button govuk-button--primary", style: "margin-inline-end: 1rem;" %>
    <% end %>

      <%= form_with(
          model: @consultation,
          url: planning_application_consultation_path(@planning_application)
        ) do |form| %>
        <%= form.hidden_field :neighbour_letter_text %>
        <%= form.submit "Save and come back later", class: "govuk-button govuk-button--secondary", data: { module: "govuk-button" } %>
        <%= link_to "Back", planning_application_consultation_path(@planning_application), class: "govuk-button govuk-button--secondary" %>
      <% end %>
    </div>
  </div>  
</div>
