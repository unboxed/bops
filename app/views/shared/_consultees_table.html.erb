<table class="govuk-table">
  <thead class="govuk-table__head">
  <tr class="govuk-table__row">
    <th class="govuk-table__header">Reason/constraint</th>
    <th class="govuk-table__header">Consultees</th>
    <th class="govuk-table__header govuk-!-text-align-right">Status</th>
  </tr>
  </thead>
  <tbody class="govuk-table__body">
  <% if @planning_application.planning_application_constraints.none? && @planning_application.consultation.consultees.unassigned.none? %>
    <tr class="govuk-table__row" data-consultees-target="noConsultees">
      <td class="govuk-table__cell" colspan="3">
        <strong>No reasons or constraints have been identified, so there are no suggested consultees.</strong>
      </td>
    </tr>
  <% else %>
    <% @planning_application.planning_application_constraints.each do |constraint| %>
      <% assigned_consultees = constraint.consultees %>
      <% next if assigned_consultees.empty? && !show_assign %>

      <tr class="govuk-table__row">
        <td class="govuk-table__cell">
          <%= constraint.type_code %>
        </td>
        <td class="govuk-table__cell">
          <% if assigned_consultees.any? %>
            <ul class="govuk-list consultee-list">
              <% assigned_consultees.each do |consultee| %>
                <li class="consultee-list__item">
                  <span class="consultee-list__name"><%= consultee.name %></span>
                </li>
              <% end %>
            </ul>

            <% unless @planning_application.determined? %>
              <div class="govuk-!-margin-top-2">
                <%= govuk_link_to "Manage consultees", new_planning_application_consultee_path(@planning_application, constraint: constraint) %>
              </div>
            <% end %>
          <% elsif @planning_application.determined? %>
            &ndash;
          <% else %>
            <ul class="govuk-list consultee-list">
              <li class="consultee-list__item">
                <span class="consultee-list__name">
                  <%= govuk_link_to "Assign consultees", new_planning_application_consultee_path(@planning_application, constraint: constraint) %>
                </span>
              </li>
            </ul>
          <% end %>
        </td>
        <td class="govuk-table__cell govuk-!-text-align-right consultee-status-cell">
          <% if assigned_consultees.any? %>
            <ul class="govuk-list consultee-status-list">
              <% assigned_consultees.each do |consultee| %>
                <li class="consultee-status-list__item">
                  <%= render StatusTags::BaseComponent.new(status: consultee.status) %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <ul class="govuk-list consultee-status-list">
              <li class="consultee-status-list__item">
                <%= render StatusTags::BaseComponent.new(status: "not_assigned") %>
              </li>
            </ul>
          <% end %>

          <% unless constraint.consultation_required? %>
            <div class="consultee-status-list__constraint-status">
              <%= render StatusTags::BaseComponent.new(status: "not_required") %>
            </div>
          <% end %>
        </td>
      </tr>
    <% end %>
    <% @planning_application.consultation.consultees.unassigned.find_each do |consultee| %>
      <tr class="govuk-table__row">
        <td class="govuk-table__cell">Other</td>
        <td class="govuk-table__cell">
          <ul class="govuk-list consultee-list">
            <li class="consultee-list__item">
              <span class="consultee-list__name"><%= consultee.name %></span>
            </li>
          </ul>
        </td>
        <td class="govuk-table__cell govuk-!-text-align-right consultee-status-cell">
          <ul class="govuk-list consultee-status-list">
            <li class="consultee-status-list__item">
              <%= render StatusTags::BaseComponent.new(status: consultee.status) %>
            </li>
          </ul>
        </td>
      </tr>
    <% end %>
  <% end %>
  </tbody>
</table>
<template data-consultees-target="template">
  <tr class="govuk-table__row just-added">
    <td class="govuk-table__cell">Other</td>
    <td class="govuk-table__cell">
      <ul class="govuk-list consultee-list">
        <li class="consultee-list__item">
          <span class="consultee-list__name consultee-name"></span>
        </li>
      </ul>
    </td>
    <td class="govuk-table__cell govuk-!-text-align-right consultee-status-cell">
      <ul class="govuk-list consultee-status-list">
        <li class="consultee-status-list__item consultee-status">
          <span class="govuk-tag govuk-tag--grey"><%= "Not consulted" %></span>
        </li>
      </ul>
    </td>
  </tr>
</template>
