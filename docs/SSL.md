# SSL management and renewal processes

Councils can either generate a SSL certificate themselves and send it to us, or we can generate a <abbr title="certificate signing request">CSR</abbr> and send it to them, and they send the certificate back. (Note that if we generated the original CSR, they may still be able to renew it themselves and send us a new certificate each year without needing a new CSR.)

In either case, once we have the public certificate and chain certificate from them we can upload it to AWS Certificate Manager.

## Generating a CSR file

There is a script in the `bops-terraform` repository which will generate the required CSR:

```sh
$ bin/generate-csr "London Borough of Southwark" southwark
Generating a 2048 bit RSA private key
........................................+++++
...............................................+++++
writing new private key to 'planningapplications.southwark.gov.uk.key'
-----
CSR generated: planningapplications.southwark.gov.uk.csr

```

Store the generated key in 1Password and send the CSR to the council's IT contact.

## Reading a certificate generated by a council

They will send a PFX file in a password-protected zip. We need to unzip it with the password they provide, usually in a separate email.

Run the following command to convert it to the required format:

```sh
$ openssl pkcs12 -nodes -passin pass:[PASSWORD] -in <pfx_file>
...
```

If there is an algorithm error, it may be necessary to use the `-legacy` flag:

```sh
$ openssl pkcs12 -nodes -legacy -passin pass:[PASSWORD] -in <pfx_file>
...
```

## Importing a certificate into AWS Certificate Manager

1. Navigate to Certificate Manager.
2. Navigate in the US East (N. Virginia) Region (us-east-1).
3. Click on import.
4. Input certificate details as below.

Certificate body:

```
-----BEGIN CERTIFICATE-----
XXXXXXXXXXXXXXXXXXXXXXXXX
-----END CERTIFICATE-----
```

This is the server certificate which will be provided by the council IT team.

Certificate private key:

```
-----BEGIN PRIVATE KEY-----
XXXXXXXXXXXXXXXXXXXXXXXXX
-----END CERTIFICATE-----
```

The private key is the one we generated and is the file that ends `.key`.

Certificate chain:

```
-----BEGIN CERTIFICATE-----
XXXXXXXXXXXXXXXXXXXXXXXXX
-----END CERTIFICATE-----
```

This is the Intermediate/chain certificate which may be provided by council IT team. If none was provided, then leave it empty.

## Updating a certificate in AWS Certificate Manager

1. Navigate to Certificate Manager.
2. Navigate in the US East (N. Virginia) Region (us-east-1).
3. Click on List certificates.
4. Find the existing certificate.
5. Click Reimport.
6. Import the renewed certificate (`.pem` file) into Keychain Access and you will see the certificates such as “Entrust Certification Authority”, “Entrust Root Certification Authority”, “planningapplications.southwark.gov.uk”. You can save these certificates locally as a .pem file and open in your terminal / code editor
7. Add the certificate body (i.e. “planningapplications.southwark.gov.uk”), private key (from when the CSR was created) and certificate chain (“Entrust Root Certification Authority”).

> TODO document step 7 using the openssl CLI tool rather than MacOS keychain Access

## List of Councils with SSL certificates

> TODO is this sensitive?
