<div data-controller="unsaved-changes"
     data-action="beforeunload@window->unsaved-changes#handleBeforeUnload">
  <%= form_with model: @form, url: @form.url,
        data: {unsaved_changes_target: "form", action: "submit->unsaved-changes#handleSubmit"} do |form| %>
    <%= form.govuk_error_summary %>
    <%= return_to_hidden_field %>

  <%= render "task_header", task: @task %>

  <% if @form.site_visits.any? %>
    <table class="govuk-table" id="site-visit-history">
      <caption class="govuk-table__caption govuk-table__caption--m">
        Site visit history
      </caption>

      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Site visit date</th>
          <th scope="col" class="govuk-table__header govuk-!-width-one-quarter">Address</th>
          <th scope="col" class="govuk-table__header">Case officer</th>
          <th scope="col" class="govuk-table__header govuk-!-width-one-half">Comment</th>
          <th scope="col" class="govuk-table__header">Action</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">
        <% @form.each_site_visit do |site_visit| %>
        <%= form.hidden_field :site_visit_id, value: site_visit.id %>
        <tbody class="govuk-table__body">
          <tr class="govuk-table__row">
            <th scope="row" class="govuk-table__header">
              <%= site_visit.visited_on %>
            </th>
            <td class="govuk-table__cell">
              <%= site_visit.address %>
            </td>
            <td class="govuk-table__cell"><%= site_visit.created_by %></td>
            <td class="govuk-table__cell">
              <%= site_visit.comment %>
              <% site_visit.documents.each do |document| %>
                <p class="govuk-!-margin-top-3 govuk-!-margin-bottom-1">
                  <%= document_thumbnail_link document, thumbnail_args: {resize: "180x135"} %>
                </p>
                <p>
                  <%= link_to_document "View in new window", document %>
                </p>
              <% end %>
            <td class="govuk-table__cell govuk-table__cell--numeric">
              <%= govuk_link_to "Edit", @form.route_for(:edit_task, @planning_application, @task, site_visit_id: site_visit.id, only_path: true) %>
              <%= form.govuk_task_button "Remove", action: "remove_site_visit", class: "button-as-link" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="govuk-!-padding-3 govuk-!-margin-bottom-6 background-light-grey">
      <p class="govuk-!-margin-bottom-2">
        <strong>No site visits have been recorded yet.</strong>
      </p>
      <p class="govuk-!-margin-bottom-0">
        Add new site visit to start recording site visit history.
      </p>
    </div>
  <% end %>

  <% unless @planning_application.determined? %>
    <%= govuk_details(summary_text: "Add new site visit", open: @form.add_site_visit_open?) do %>
      <%= render "bops_preapps/tasks/check-and-assess/additional-services/site-visit/form", form: form %>
    <% end %>
  <% end %>

    <%= render "task_submit_buttons", form: form %>
  <% end %>
</div>
